<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App 2: Forest of Specialists v2.0 | Coherence Bridge</title>
    <style>
        :root {
            --matrix-green: #00ff41; --void-black: #0d0208; --text-white: #f0fdf4;
            --danger-red: #ff3131; --gold: #ffd700; --panel-bg: #111827; --border: #22c55e;
            --blue: #3b82f6;
        }
        body { font-family: 'Courier New', monospace; background: var(--void-black); color: var(--text-white); margin: 0; padding: 20px; line-height: 1.5; }
        .app-container { max-width: 1150px; margin: 0 auto; border: 2px solid var(--border); border-radius: 12px; background: rgba(13, 2, 8, 0.98); position: relative; }
        header { padding: 1.5rem; border-bottom: 2px solid var(--border); text-align: center; background: #052e16; }
        
        .layout { display: grid; grid-template-columns: 1fr 350px; gap: 20px; padding: 20px; }
        .card { border: 1px solid var(--border); padding: 1.5rem; border-radius: 8px; background: #000; margin-bottom: 15px; }

        /* The Tree Canvas Area */
        .tree-viewport { height: 350px; background: #000; border: 1px solid var(--border); position: relative; overflow: hidden; display: flex; justify-content: center; align-items: flex-end; padding-bottom: 20px; }
        .branch-line { position: absolute; background: var(--matrix-green); width: 4px; transition: 0.5s; opacity: 0.6; }
        .handshake-glow { position: absolute; bottom: 100px; width: 20px; height: 20px; background: var(--gold); border-radius: 50%; box-shadow: 0 0 20px var(--gold); display: none; }

        /* Specialist Cards */
        .specialist-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .spec-box { border: 1px solid var(--border); padding: 10px; text-align: center; background: #051a05; }
        .spec-name { font-weight: bold; color: var(--gold); display: block; }
        .status-tag { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; background: #1e293b; }
        
        /* Interaction Controls */
        .btn { width: 100%; padding: 12px; border: 1px solid var(--matrix-green); background: none; color: var(--matrix-green); cursor: pointer; font-weight: bold; font-family: inherit; transition: 0.2s; margin-top: 8px; }
        .btn:hover { background: var(--matrix-green); color: black; }
        .btn-handshake { border-color: var(--gold); color: var(--gold); }
        .hidden { display: none !important; }

        /* Overlays */
        #orientation-overlay, #audit-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .modal { max-width: 650px; border: 2px solid var(--border); padding: 30px; border-radius: 12px; background: #000; box-shadow: 0 0 30px var(--matrix-green); }

        .sidebar { font-size: 0.85rem; border-left: 1px solid var(--border); padding-left: 20px; }
        dt { font-weight: bold; color: var(--gold); margin-top: 10px; }
        dd { margin: 0 0 10px 0; color: #cbd5e1; }
    </style>
</head>
<body>

<div id="orientation-overlay">
    <div class="modal">
        <h2>App 2 Orientation: The Forest Bridge</h2>
        <p>In App 1, you learned to defend your own substrate. In App 2, you are a <strong>Coherence Engineer</strong>.</p>
        <p><strong>Your Mission:</strong> Coordinate between a <strong>Western Doctor</strong> and an <strong>Indigenous Shaman</strong> to solve a community crisis.</p>
        <p><strong>The Challenge:</strong> You must protect their <strong>Morphic Fidelity</strong> (their unique truths) while identifying the <strong>Trunk of Humanity</strong> they share. Beware: Systems of extraction are still at work here!</p>
        <button class="btn" onclick="closeModal('orientation-overlay')">Begin Handshake Protocol</button>
    </div>
</div>

<div id="audit-overlay" class="hidden">
    <div class="modal">
        <h2>Handshake Performance Audit</h2>
        <div id="audit-content"></div>
        <button class="btn" onclick="location.reload()">Reset Bridge</button>
    </div>
</div>

<div class="app-container">
    <header>
        <h1>FOREST OF SPECIALISTS v2.0</h1>
        <p>Structural Recognition & Ultrametric Coordination</p>
    </header>

    <div class="layout">
        <main>
            <div class="tree-viewport" id="viewport">
                <div class="branch-line" style="height: 100px; bottom: 0; left: 50%; width: 6px;" title="Universal Trunk"></div>
                <div class="branch-line" style="height: 150px; bottom: 100px; left: 35%; transform: rotate(-25deg);" title="Scientific Branch"></div>
                <div class="branch-line" style="height: 150px; bottom: 100px; left: 65%; transform: rotate(25deg);" title="Indigenous Branch"></div>
                <div id="glow" class="handshake-glow" style="left: calc(50% - 10px);"></div>
            </div>

            <div class="specialist-grid">
                <div class="spec-box">
                    <span class="spec-name">Dr. Aris (Science)</span>
                    <span class="status-tag" id="aris-status">COHERENT</span>
                </div>
                <div class="spec-box">
                    <span class="spec-name">Elder Sora (Narrative)</span>
                    <span class="status-tag" id="sora-status">COHERENT</span>
                </div>
            </div>

            <div class="card" id="interaction-panel">
                <h3 id="task-title">Bridge Condition: Analyzing...</h3>
                <p id="task-desc">A local community is suffering from <strong>Incidental Depletion</strong>. Both specialists are arguing over "who is right."</p>
                
                <div id="step-1" class="hidden">
                    <p><strong>Step 1: Perform Extraction Audit.</strong> Is the system design depleting them?</p>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn" onclick="audit('incidental')">Incidental Depletion</button>
                        <button class="btn" onclick="audit('intentional')">Intentional Extraction</button>
                    </div>
                </div>

                <div id="step-2" class="hidden">
                    <p><strong>Step 2: Identify Shared Node.</strong> Where do these branches meet?</p>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-handshake" onclick="handshake('trunk')">Authorize Shared Node: Healer ($p^0$)</button>
                        <button class="btn" onclick="handshake('homogenize')">Force Agreement (Tolerance)</button>
                    </div>
                </div>

                <button id="start-btn" class="btn" onclick="nextTask()">Begin System Diagnosis</button>
            </div>
        </main>

        <aside class="sidebar">
            <h2>Bridge Glossay</h2>
            <dl>
                <dt>Ultrametric Distance</dt>
                <dd>The depth you must travel down the tree to find a shared ancestor. Lower $p$ = deeper connection.</dd>
                <dt>Morphic Fidelity</dt>
                <dd>Respecting that the Doctor treats the body ($B$) and the Shaman treats the narrative ($A$). They do not need to be the same to work together.</dd>
                <dt>Extraction Matrix</dt>
                <dd>Before they can help others, you must ensure the <em>system</em> isn't extracting their agency.</dd>
            </dl>
            
        </aside>
    </div>
</div>

<script>
    let currentStep = 0;
    let auditCorrect = false;
    let handshakeCorrect = false;

    function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

    function nextTask() {
        document.getElementById('start-btn').classList.add('hidden');
        document.getElementById('step-1').classList.remove('hidden');
        document.getElementById('task-title').innerText = "System Audit in Progress";
    }

    function audit(choice) {
        auditCorrect = (choice === 'incidental');
        document.getElementById('step-1').classList.add('hidden');
        document.getElementById('step-2').classList.remove('hidden');
        
        // Visual feedback
        if(!auditCorrect) {
            document.getElementById('aris-status').innerText = "DEPLETED";
            document.getElementById('aris-status').style.background = "var(--danger-red)";
        }
    }

    function handshake(choice) {
        handshakeCorrect = (choice === 'trunk');
        document.getElementById('step-2').classList.add('hidden');
        if(handshakeCorrect) {
            document.getElementById('glow').style.display = 'block';
        }
        generateAudit();
    }

    function generateAudit() {
        const auditDiv = document.getElementById('audit-content');
        let feedback = "";

        if (auditCorrect && handshakeCorrect) {
            feedback = `<h3>SUCCESS: FULL COHERENCE REACHED</h3>
            <p><strong>Review:</strong> You correctly identified that the tension was <em>Incidental Depletion</em>. By finding the <strong>Shared Node ($p^0$)</strong>, you allowed both to maintain their Morphic Fidelity while solving the crisis.</p>`;
        } else if (auditCorrect && !handshakeCorrect) {
            feedback = `<h3>FAILURE: COGNITIVE HOMOGENIZATION</h3>
            <p><strong>Review:</strong> You diagnosed the harm correctly, but you tried to force "Tolerance." By making them agree, you erased their unique specialists' depth. The bridge collapsed.</p>`;
        } else {
            feedback = `<h3>FAILURE: SYSTEMIC COLLAPSE</h3>
            <p><strong>Review:</strong> You failed to see the <em>Incidental Depletion</em>. Because the system was draining the Doctor, he had no metabolic budget to coordinate with the Shaman.</p>`;
        }

        auditDiv.innerHTML = feedback;
        document.getElementById('audit-overlay').classList.remove('hidden');
    }
</script>
</body>
</html>
